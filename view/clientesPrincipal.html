<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>ReeUtil</title>
	<link rel="stylesheet" href="stylesClientes.css" />
</head>

<body>
	<header>
		<div class="container-hero">
			<div class="container hero">
				<div class="customer-support">
					<i class="fa-solid fa-recycle"></i>
					<div class="content-customer-support">
						<span class="text">Reinicia tu dispositivo</span>
					</div>
				</div>

				<div class="container-logo">
					<i class="fa-solid fa-cog"></i>
					<h1 class="logo"><a href="/">ReeUtil</a></h1>
				</div>

				<div class="container-user">
					<i class="fa-solid fa-user"></i>
					<i class="fa-solid fa-basket-shopping"></i>
					<div class="content-shopping-cart">
						<span class="text">Carrito</span>
						<span class="number">(0)</span>
					</div>
				</div>
			</div>
		</div>

		<div class="container-navbar">
			<nav class="navbar container">
				<i class="fa-solid fa-bars"></i>
				<ul class="menu">
					<li><a href="#">Inicio</a></li>
					<li><a href="#">Dispositivos</a></li>
					<li><a href="#" id="openCotizacionModal">Cotizacion</a></li>
					<li><a href="#" id="openModal">Solicitud de evaluación</a></li>
					<li><a href="#">Más</a></li>
				</ul>

				<form class="search-form">
					<input type="search" placeholder="Buscar..." />
					<button class="btn-search">
						<i class="fa-solid fa-magnifying-glass"></i>
					</button>
				</form>
			</nav>
		</div>
	</header>
	<div id="cotizacionModal" class="modal">
		<div class="modal-content">
			<span class="closeCotizacionModal">&times;</span>
			<h2>Detalles de Cotización</h2>
			<table id="cotizacionTable" border="1">
				<thead>
					<tr>
						<th>Cotización</th>
						<th>Detalles</th>
						<th>Estado Cotización</th>
						<th>Estado Dispositivo</th>
						<th>Fecha</th>
						<th>Id Catálogo</th>
						<th>Id Usuario</th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
		</div>
	</div>
	<script>
		const cotizacionModal = document.getElementById("cotizacionModal");
		const openCotizacionModalButton = document.getElementById("openCotizacionModal");
		const closeCotizacionModalButton = document.getElementsByClassName("closeCotizacionModal")[0];
	
		// Function to fetch data from API
		async function cargar() {
			try {
				const response = await fetch('http://localhost:5500/obteCoti', {
					method: 'GET',
					headers: {
						'Content-Type': 'application/json'
					}
				});
	
				if (!response.ok) {
					throw new Error(`HTTP error! Status: ${response.status}`);
				}
	
				const productos = await response.json();  
				return productos;
			} catch (error) {
				console.error('Error al obtener productos:', error);
				return null;  
			}
		}
	
		openCotizacionModalButton.addEventListener("click", async () => {
			const tableBody = document.querySelector("#cotizacionTable tbody");
			tableBody.innerHTML = ""; 
			const productos = await cargar();
	
			if (!productos) {
				console.error('No hay productos disponibles o ha ocurrido un error.');
				return; 
			}
	
			const filteredData = productos.filter(data => data.estadoCotizaci === "Pendiente");
			if (filteredData.length === 0) {
				console.log('No hay productos con estado de cotización "Pendiente".');
			}
	
			filteredData.forEach(data => {
				const row = document.createElement("tr");
	
				row.innerHTML = `
					<td>${data.cotizacion || 'N/A'}</td>
					<td>${data.detalles || 'Sin detalles'}</td>
					<td>${data.estadoCotizaci}</td>
					<td>${data.estadoDisposit}</td>
					<td>${new Date(data.fecha).toLocaleDateString()}</td>
					<td>${data.idCatalogo}</td>
					<td>${data.idUsuario}</td>
					<td>
						<button class="btn-aceptar">Aceptar</button>
						<button class="btn-rechazar">Rechazar</button>
					</td>
				`;
				tableBody.appendChild(row);
	
				// Event listener para el botón "Aceptar"
				const btnAceptar = row.querySelector(".btn-aceptar");
				btnAceptar.addEventListener("click", async () => {
					try {
						const response = await fetch('http://localhost:5500/actualizarCotizacionDP', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json'
							},
							body: JSON.stringify({ id: data._id, estadoCotizaci: 'aceptado' }) // Asegúrate de enviar el _id correctamente
						});
	
						const result = await response.json(); // Capturamos la respuesta del servidor
	
						if (response.ok) {
							alert('Cotización aceptada');
							data.estadoCotizaci = 'aceptado';
							row.querySelector('td:nth-child(3)').innerText = 'aceptado'; // Actualizar el estado en la tabla
						} else {
							console.error('Error del servidor:', result);
							alert(`Error al aceptar la cotización: ${result.error || 'Error desconocido'}`);
						}
					} catch (error) {
						console.error('Error al aceptar la cotización:', error);
						alert('Error de conexión al aceptar la cotización');
					}
				});
	
				// Event listener para el botón "Rechazar"
				const btnRechazar = row.querySelector(".btn-rechazar");
				btnRechazar.addEventListener("click", async () => {
					try {
						const response = await fetch('http://localhost:5500/actualizarCotizacionDP', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json'
							},
							body: JSON.stringify({ id: data._id, estadoCotizaci: 'rechazado' }) // Asegúrate de enviar el _id correctamente
						});
	
						const result = await response.json(); // Capturamos la respuesta del servidor
	
						if (response.ok) {
							alert('Cotización rechazada');
							data.estadoCotizaci = 'rechazado';
							row.querySelector('td:nth-child(3)').innerText = 'rechazado'; // Actualizar el estado en la tabla
						} else {
							console.error('Error del servidor:', result);
							alert(`Error al rechazar la cotización: ${result.error || 'Error desconocido'}`);
						}
					} catch (error) {
						console.error('Error al rechazar la cotización:', error);
						alert('Error de conexión al rechazar la cotización');
					}
				});
			});
	
			// Mostrar el modal
			cotizacionModal.style.display = "block";
		});
	
		// Close the modal when the 'x' is clicked
		closeCotizacionModalButton.addEventListener("click", () => {
			cotizacionModal.style.display = "none";
		});
	
		// Close modal if user clicks outside the modal content
		window.onclick = function (event) {
			if (event.target == cotizacionModal) {
				cotizacionModal.style.display = "none";
			}
		}
	</script>
	

	<!-- Modal para Formulario -->
	<div id="solicitudModal" class="modal FormS-modal">
		<div class="modal-content FormS-modal-content">
			<span id="closeSolicitudModal" class="close FormS-close">&times;</span>
			<h2>Solicitar Dispositivo</h2>
			<div id="mensaje" class="mensaje-oculto"></div>
			<form id="solicitudForm" class="FormS-form">
				<label for="equipo">Equipo Solicitado:</label>
				<input type="text" id="equipo" name="equipo" readonly />
				<input type="hidden" id="idCatalogo" name="idCatalogo" />

				<label for="imagen">Subir Imagen:</label>
				<!--<input type="file" id="imagen" name="imagen" />-->

				<label for="estado">Estado del Dispositivo:</label>
				<select id="estado" name="estado">
					<option value="Operativo">Operativo</option>
					<option value="Regular">Regular</option>
					<option value="No_funcional">No Funcional</option>
				</select>

				<label for="detalles">Detalles:</label>
				<textarea id="detalles" name="detalles" rows="4" placeholder="Proporcione más detalles..."></textarea>
				<button type="submit" class="FormS-submit">Enviar Solicitud</button>
			</form>
		</div>
	</div>
	<script>
		document.getElementById('solicitudForm').addEventListener('submit', async function (event) {
			event.preventDefault();

			const formData = new FormData(this);
			const data = Object.fromEntries(formData.entries());
			const idUsuario = localStorage.getItem('idUsuario');
			console.log('idUsuario en localStorage:', idUsuario);

			if (idUsuario) {
				data.idUsuario = idUsuario; // Agregar el idUsuario al objeto `data`
			} else {
				mostrarMensaje('idUsuario no encontrado en localStorage', 'error');
				return;
			}

			try {
				const response = await fetch('http://localhost:5500/envcotizacion', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify(data)
				});

				const result = await response.json();

				if (response.ok) {
					mostrarMensaje('Datos enviados correctamente', 'exito');
				} else {
					mostrarMensaje('Error al enviar los datos: ' + result.message, 'error');
				}

			} catch (error) {
				mostrarMensaje('Error en la solicitud: ' + error.message, 'error');
			}
		});
		function mostrarMensaje(mensaje, tipo) {
			const mensajeDiv = document.getElementById('mensaje');

			// Cambiar el texto del mensaje
			mensajeDiv.textContent = mensaje;

			// Quitar las clases previas y asignar la clase según el tipo
			if (tipo === 'exito') {
				mensajeDiv.classList.remove('mensaje-error');
				mensajeDiv.classList.add('mensaje-exito');
			} else if (tipo === 'error') {
				mensajeDiv.classList.remove('mensaje-exito');
				mensajeDiv.classList.add('mensaje-error');
			}

			// Asegurarse de que el mensaje esté visible
			mensajeDiv.style.display = 'block';

			// Ocultar el mensaje después de 5 segundos
			setTimeout(() => {
				mensajeDiv.style.display = 'none';
			}, 5000);
		}
	</script>

	<section class="banner">
		<div class="content-banner">
			<p>Reinicio de dispositivos</p>
			<h2>100% Calidad <br />Recicla tus gadgets</h2>
			<a href="#">Cotizar ahora</a>
		</div>
	</section>

	<main class="main-content">
		<section class="container container-features">
			<div class="card-feature">
				<i class="fa-solid fa-recycle"></i>
				<div class="feature-content">
					<span>Reciclar ayuda al medio ambiente</span>
					<p>Dando un reinicio a tu disposito </p>
				</div>
			</div>
			<div class="card-feature">
				<i class="fa-solid fa-wallet"></i>
				<div class="feature-content">
					<span>Tan fácil en la web</span>
					<p>Cotiza tus dispositivos atraves de la web</p>
				</div>
			</div>
			<div class="card-feature">
				<i class="fa-solid fa-gift"></i>
				<div class="feature-content">
					<span>Ofertas y regalos</span>
					<p>Ofrece bonos especiales con regalo</p>
				</div>
			</div>
			<div class="card-feature">
				<i class="fa-solid fa-headset"></i>
				<div class="feature-content">
					<span>Servicio al cliente 24/7</span>
					<p>Atencion de alta calidad</p>
				</div>
			</div>
		</section>

		<section class="container top-categories">
			<h1 class="heading-1">Top Categorías</h1>
			<div class="container-categories">
				<div class="card-category category-electro">
					<p>Electrodomesticos</p>
					<span>Ver más</span>
				</div>
				<div class="card-category category-tecno">
					<p>Tecnologia</p>
					<span>Ver más</span>
				</div>
				<div class="card-category category-waer">
					<p>Wearable</p>
					<span>Ver más</span>
				</div>
			</div>
		</section>

		<div id="productModal" class="modal">
			<div class="modal-content">
				<span class="closepro">&times;</span>
				<div class="modal-body">
					<img id="modal-product-image" src="" alt="" class="modal-product-img" />
					<h2 id="modal-product-name"></h2>
					<p id="modal-product-description"></p>
					<p id="modal-product-marca"></p>
					<p id="modal-product-type"></p>
				</div>
			</div>
		</div>

		<section class="container top-products">
			<h1 class="heading-1">Mejores Productos</h1>

			<div class="container-options">
				<span class="active">Destacados</span>
				<span>Más recientes</span>
				<span>Más cotizados</span>
			</div>

			<div class="carousel-container">
				<button class="carousel-btn prev-btn">&lt;</button>
				<div class="carousel-track-container">
					<div class="carousel-track" id="carousel-track">
						<script>
							// Convierte esta función en async
							async function cargarProductos() {
								try {
									const response = await fetch('http://localhost:5500/obteCatalogo', {
										method: 'GET',
										headers: {
											'Content-Type': 'application/json'
										}
									});
									const productos = await response.json();
									generarCards(productos);
									iniciarCarrusel();
								} catch (error) {
									console.error('Error al obtener productos:', error);
								}
							}

							// Llama a la función cargarProductos cuando se cargue la página
							window.addEventListener('DOMContentLoaded', cargarProductos);

							// Función para generar las tarjetas de productos
							function generarCards(productos) {
								const track = document.getElementById('carousel-track');
								track.innerHTML = ''; // Limpiar el contenedor antes de agregar productos

								productos.forEach(producto => {
									const card = document.createElement('div');
									card.classList.add('card-product');

									// Verificar si imagenProdu tiene un valor válido y construir la URL
									let imagenRuta = 'ruta_defecto.jpg'; // Ruta por defecto en caso de que no haya imagen
									if (producto.imagenProdu) {
										// Extraer solo el nombre del archivo y construir la URL para acceder al servidor
										const nombreArchivo = producto.imagenProdu.split('\\').pop(); // Tomar solo el nombre del archivo
										imagenRuta = `/uploads/${nombreArchivo}`; // Construir la URL correcta
									}

									card.innerHTML = `
										<div class="container-img">
											<img src="${imagenRuta}" alt="${producto.nombre}" />
											<div class="button-group">
												<span class="view-product"><i class="fa-regular fa-eye"></i></span>
											</div>
										</div>
										<div class="content-card-product">
											<h3>${producto.nombre}</h3>
											<span class="add-cart"><i class="fa-solid fa-basket-shopping"></i></span>
											<p class="tipo">${producto.tipo}</p>
										</div>
									`;

									track.appendChild(card);

									const viewButton = card.querySelector('.view-product');
									viewButton.addEventListener('click', () => {
										mostrarModalProducto(producto);
									});
								});
							}




							// Función para iniciar el carrusel
							function iniciarCarrusel() {
								const track = document.querySelector('.carousel-track');
								const prevButton = document.querySelector('.prev-btn');
								const nextButton = document.querySelector('.next-btn');
								let currentIndex = 0;

								// Función para calcular el ancho total de todas las tarjetas dentro del carrusel
								const calcularAnchoTotal = () => {
									let totalWidth = 0;
									const cards = document.querySelectorAll('.card-product');
									cards.forEach(card => {
										const cardStyle = window.getComputedStyle(card);
										const cardWidth = card.getBoundingClientRect().width;
										const marginLeft = parseFloat(cardStyle.marginLeft);
										const marginRight = parseFloat(cardStyle.marginRight);
										totalWidth += cardWidth + marginLeft + marginRight;
									});
									return totalWidth;
								};

								const calcularAnchoTarjeta = () => {
									const cardProduct = document.querySelector('.card-product');

									// Verificar si existe alguna tarjeta antes de calcular su ancho
									if (!cardProduct) {
										console.error("No se encontró ningún elemento con la clase 'card-product'. Asegúrate de que las tarjetas existan antes de calcular su ancho.");
										return 0;
									}

									const cardStyle = window.getComputedStyle(cardProduct);
									const cardWidth = cardProduct.getBoundingClientRect().width;
									const marginLeft = parseFloat(cardStyle.marginLeft);
									const marginRight = parseFloat(cardStyle.marginRight);
									return cardWidth + marginLeft + marginRight;
								};

								let cardWidth = calcularAnchoTarjeta();
								let totalWidth = calcularAnchoTotal();

								// Recalcular el ancho si la ventana cambia de tamaño (responsive)
								window.addEventListener('resize', () => {
									cardWidth = calcularAnchoTarjeta();
									totalWidth = calcularAnchoTotal();
								});

								nextButton.addEventListener('click', () => {
									const itemsToShow = Math.floor(track.clientWidth / cardWidth);
									const totalItems = track.children.length;
									const maxScroll = totalWidth - track.clientWidth;

									// Actualizar la posición del índice
									if (currentIndex < totalItems - itemsToShow) {
										currentIndex++;
										const currentScroll = currentIndex * cardWidth;

										// Verificar que el desplazamiento no exceda el máximo
										track.style.transform = `translateX(-${Math.min(currentScroll, maxScroll)}px)`;
									}
								});

								prevButton.addEventListener('click', () => {
									if (currentIndex > 0) {
										currentIndex--;
										track.style.transform = `translateX(-${currentIndex * cardWidth}px)`;
									}
								});
							}

							// Inicia la carga de productos cuando el DOM esté completamente cargado
							document.addEventListener('DOMContentLoaded', cargarProductos);

							function mostrarModalProducto(productos) {
								const modal = document.getElementById('productModal');
								const modalImg = document.getElementById('modal-product-image');
								const modalName = document.getElementById('modal-product-name');
								const modalMarca = document.getElementById('modal-product-marca');
								const modalDescription = document.getElementById('modal-product-description');
								const modalType = document.getElementById('modal-product-type');

								//modalImg.src = producto.imagen;
								modalName.textContent = productos.nombre;
								modalDescription.textContent = productos.descripcion;
								modalMarca.textContent = productos.marca;
								modalType.textContent = productos.tipo;

								modal.style.display = 'block';

								const closeModal = document.getElementsByClassName('closepro')[0];
								closeModal.onclick = function () {
									modal.style.display = 'none';
								};

								window.onclick = function (event) {
									if (event.target === modal) {
										modal.style.display = 'none';
									}
								};
							}

							function mostrarModal(nombreEquipo, idCatalogo) {
								const modal = document.getElementById('solicitudModal');
								const equipoInput = document.getElementById('equipo');
								const idCatalogoInput = document.getElementById('idCatalogo'); // Suponiendo que tienes un campo oculto en el formulario para idCatalogo

								// Asigna el nombre del equipo al campo de texto
								equipoInput.value = nombreEquipo;

								// Asigna el idCatalogo al campo oculto en el formulario
								idCatalogoInput.value = idCatalogo;

								modal.style.display = 'block';
							}

							// Función para cerrar el modal
							function cerrarModal() {
								const modal = document.getElementById('solicitudModal');
								modal.style.display = 'none';
							}

							// Asocia el evento de cerrar modal al botón de cierre
							document.getElementById('closeModal').addEventListener('click', cerrarModal);

							// Cerrar modal al hacer clic fuera de él
							window.addEventListener('click', function (event) {
								const modal = document.getElementById('solicitudModal');
								if (event.target === modal) {
									cerrarModal();
								}
							});
						</script>
					</div>
				</div>
				<button class="carousel-btn next-btn">&gt;</button>
			</div>
		</section>

		<section class="gallery">
			<img src="1.png" alt="Gallery Img1" class="gallery-img-1" /><img src="2.png" alt="Gallery Img2"
				class="gallery-img-2" /><img src="3.png" alt="Gallery Img3" class="gallery-img-3" /><img src="2.png"
				alt="Gallery Img4" class="gallery-img-4" /><img src="1.png" alt="Gallery Img5" class="gallery-img-5" />
		</section>
	</main>

	<footer class="footer">
		<div class="container container-footer">
			<div class="menu-footer">
				<div class="contact-info">
					<p class="title-footer">Información de Contacto</p>
					<ul>
						<li>
							Dirección: lililalalalal
						</li>
						<li>Teléfono: 123-456-7890</li>
						<li>EmaiL: Cookies@support.com</li>
					</ul>
					<div class="social-icons">
						<span class="facebook">
							<i class="fa-brands fa-facebook-f"></i>
						</span>
						<span class="twitter">
							<i class="fa-brands fa-twitter"></i>
						</span>
						<span class="youtube">
							<i class="fa-brands fa-youtube"></i>
						</span>
						<span class="pinterest">
							<i class="fa-brands fa-pinterest-p"></i>
						</span>
						<span class="instagram">
							<i class="fa-brands fa-instagram"></i>
						</span>
					</div>
				</div>

				<div class="information">
					<p class="title-footer">Información</p>
					<ul>
						<li><a href="#">Acerca de Nosotros</a></li>
						<li><a href="#">Información Delivery</a></li>
						<li><a href="#">Politicas de Privacidad</a></li>
						<li><a href="#">Términos y condiciones</a></li>
						<li><a href="#">Contactános</a></li>
					</ul>
				</div>

				<div class="my-account">
					<p class="title-footer">Mi cuenta</p>

					<ul>
						<li><a href="#">Mi cuenta</a></li>
						<li><a href="#">Historial de ordenes</a></li>
						<li><a href="#">Lista de deseos</a></li>
						<li><a href="#">Boletín</a></li>
						<li><a href="#">Reembolsos</a></li>
					</ul>
				</div>

				<div class="newsletter">
					<p class="title-footer">Boletín informativo</p>

					<div class="content">
						<p>
							Suscríbete y mantente al
							día con nuevas colecciones y ofertas exclusivas.
						</p>
						<input type="email" placeholder="Ingresa el correo aquí...">
						<button>Suscríbete</button>
					</div>
				</div>
			</div>

			<div class="copyright">
				<p>
					Los cookies &copy; 2024
				</p>

			</div>
		</div>
	</footer>

	<script src="https://kit.fontawesome.com/81581fb069.js" crossorigin="anonymous"></script>
	<script src="solicitudes.js"></script>
</body>

</html>